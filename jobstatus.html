<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Job Status Viewer</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    summary {
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
    .status-complete {
      background-color: #d4edda;
      color: #155724;
    }
    .status-failed {
      background-color: #f8d7da;
      color: #721c24;
    }
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    .summary-box {
      background: #f4f4f4;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>üìä Job Status Dashboard</h1>
  <p>Select your JSON file containing the <code>run_results</code>:</p>
  <input type="file" id="fileInput" accept=".json">
  <div id="summary"></div>
  <div id="output"></div>

  <script>
    document.getElementById('fileInput').addEventListener('change', function(evt) {
      const file = evt.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const jsonData = JSON.parse(e.target.result);

        // Summary counters
        let total = 0, complete = 0, failed = 0, pending = 0;

        // Group by account > persona
        const grouped = {};
        jsonData.forEach(item => {
          const { account_id, persona_id, persona_name, scan_type, job_status } = item;
          if (!grouped[account_id]) grouped[account_id] = {};
          if (!grouped[account_id][persona_id]) {
            grouped[account_id][persona_id] = {
              name: persona_name,
              jobs: []
            };
          }
          grouped[account_id][persona_id].jobs.push({ scan_type, job_status });

          // Count status
          total++;
          const statusLower = job_status.toLowerCase();
          if (statusLower.includes("complete")) complete++;
          else if (statusLower.includes("fail") || statusLower.includes("error")) failed++;
          else pending++;
        });

        function getStatusClass(status) {
          const lower = status.toLowerCase();
          if (lower.includes("complete")) return "status-complete";
          if (lower.includes("fail") || lower.includes("error")) return "status-failed";
          return "status-pending";
        }

        // Render summary box
        const summaryHTML = `
          <div class="summary-box">
            <strong>Summary:</strong><br>
            ‚úÖ Complete: ${complete} &nbsp;&nbsp; ‚ùå Failed: ${failed} &nbsp;&nbsp; ‚è≥ Pending: ${pending}<br>
            üî¢ Total Jobs: ${total}
          </div>`;
        document.getElementById('summary').innerHTML = summaryHTML;

        // Render job details
        let outHtml = '';
        for (const account in grouped) {
          outHtml += `<details><summary>üì¶ Account: ${account}</summary>`;

          for (const persona in grouped[account]) {
            const personaData = grouped[account][persona];
            const hasIncompleteJob = personaData.jobs.some(j => !j.job_status.toLowerCase().includes("complete"));
            outHtml += `<details ${hasIncompleteJob ? 'open' : ''} style="margin-left: 20px;">
                          <summary>üë§ Persona: ${personaData.name} (ID: ${persona})</summary>
                          <table>
                            <thead>
                              <tr>
                                <th>Scan Type</th>
                                <th>Job Status</th>
                              </tr>
                            </thead>
                            <tbody>`;
            personaData.jobs.forEach(job => {
              const statusClass = getStatusClass(job.job_status);
              outHtml += `<tr class="${statusClass}">
                            <td>${job.scan_type}</td>
                            <td>${job.job_status}</td>
                          </tr>`;
            });
            outHtml += '</tbody></table></details>';
          }

          outHtml += '</details>';
        }

        document.getElementById('output').innerHTML = outHtml;
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
